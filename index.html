<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Podaży Pieniądza w Polsce</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.35.5/apexcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pl.js"></script>
    <style>
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Dashboard Podaży Pieniądza w Polsce</h1>
            <p class="text-gray-600">Interaktywna wizualizacja na podstawie rzeczywistych danych NBP</p>
            <div class="mt-2 text-sm text-gray-500">Źródło: <a href="https://github.com/dankostecki/podazpieniadza" class="text-blue-600 hover:underline" target="_blank">github.com/dankostecki/podazpieniadza</a></div>
        </header>

        <div id="loading" class="text-center py-12">
            <div class="loader"></div>
            <p class="mt-4 text-gray-600">Ładowanie danych z API...</p>
        </div>

        <div id="dashboard-content" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Karta informacyjna -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Aktualne wartości (w mln PLN)</h2>
                    <div id="current-values" class="grid grid-cols-3 gap-4">
                        <!-- Dane zostaną wstawione przez JavaScript -->
                    </div>
                </div>

                <!-- Karta z filtrowaniem -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Filtry</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Zakres czasowy</label>
                            <select id="timeRange" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                                <option value="1y">Ostatni rok</option>
                                <option value="5y">Ostatnie 5 lat</option>
                                <option value="10y">Ostatnie 10 lat</option>
                                <option value="all">Cały dostępny okres</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Agregaty</label>
                            <div id="measures-checkboxes" class="space-y-2">
                                <!-- Checkboxy zostaną wstawione przez JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Wykres liniowy - wartości bezwzględne -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Miary podaży pieniądza (mln PLN)</h2>
                    <div id="aggregateChart" class="h-80"></div>
                </div>

                <!-- Wykres słupkowy - zmiany procentowe -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Dynamika zmian r/r (%)</h2>
                    <div id="growthChart" class="h-80"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Wykres kołowy - struktura M3 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Struktura agregatu M3 (ostatni miesiąc)</h2>
                    <div id="structureChart" class="h-80"></div>
                </div>

                <!-- Wykres obszarowy - porównanie agregatów -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Porównanie agregatów</h2>
                    <div id="comparisonChart" class="h-80"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Główny skrypt do obsługi dashboardu
        document.addEventListener('DOMContentLoaded', function() {
            // Ustawienie polskiego locale dla moment.js
            moment.locale('pl');
            
            // Pobieranie danych JSON z GitHub
            fetch('https://raw.githubusercontent.com/dankostecki/podazpieniadza/main/am_data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Nie udało się pobrać danych');
                    }
                    return response.json();
                })
                .then(data => {
                    // Ukrycie loadera i pokazanie dashboardu
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('dashboard-content').classList.remove('hidden');
                    
                    // Przetworzenie danych
                    const processedData = processData(data);
                    
                    // Inicjalizacja dashboardu
                    initializeDashboard(processedData);
                })
                .catch(error => {
                    document.getElementById('loading').innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-red-600 text-4xl mb-4">⚠️</div>
                            <h2 class="text-xl font-bold text-red-600 mb-2">Błąd ładowania danych</h2>
                            <p class="text-gray-600">${error.message}</p>
                            <button id="retry-button" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Spróbuj ponownie</button>
                        </div>
                    `;
                    document.getElementById('retry-button').addEventListener('click', () => {
                        location.reload();
                    });
                });
        });

        // Funkcja do przetwarzania surowych danych
        function processData(rawData) {
            const result = {
                dates: [],
                measures: {},
                growthRates: {},
                latestValues: {},
                latestGrowthRates: {},
                categories: []
            };
            
            // Sortowanie dat
            const sortedDates = Object.keys(rawData).sort();
            result.dates = sortedDates;
            
            // Identyfikacja dostępnych miar
            if (sortedDates.length > 0) {
                const firstDateData = rawData[sortedDates[0]];
                result.categories = Object.keys(firstDateData);
                
                // Inicjalizacja struktury danych dla każdej miary
                result.categories.forEach(category => {
                    result.measures[category] = [];
                    result.growthRates[category] = [];
                });
                
                // Wypełnienie danych dla wszystkich dat
                sortedDates.forEach((date, index) => {
                    const dateData = rawData[date];
                    
                    result.categories.forEach(category => {
                        const value = dateData[category] || 0;
                        result.measures[category].push(value);
                        
                        // Obliczenie dynamiki r/r (w %)
                        if (index >= 12) {
                            const prevYearValue = rawData[sortedDates[index - 12]][category] || 0;
                            const growthRate = prevYearValue > 0 ? (value - prevYearValue) / prevYearValue * 100 : 0;
                            result.growthRates[category].push(parseFloat(growthRate.toFixed(2)));
                        } else {
                            result.growthRates[category].push(null);
                        }
                    });
                });
                
                // Ustawienie ostatnich wartości i dynamiki
                const lastDate = sortedDates[sortedDates.length - 1];
                const lastDateData = rawData[lastDate];
                
                result.categories.forEach(category => {
                    result.latestValues[category] = lastDateData[category] || 0;
                    
                    // Dynamika r/r dla ostatniej wartości
                    if (sortedDates.length > 12) {
                        const prevYearDate = sortedDates[sortedDates.length - 13];
                        const prevYearValue = rawData[prevYearDate][category] || 0;
                        const growthRate = prevYearValue > 0 ? (result.latestValues[category] - prevYearValue) / prevYearValue * 100 : 0;
                        result.latestGrowthRates[category] = parseFloat(growthRate.toFixed(2));
                    } else {
                        result.latestGrowthRates[category] = 0;
                    }
                });
            }
            
            return result;
        }

        // Funkcja do inicjalizacji całego dashboardu
        function initializeDashboard(data) {
            // Formatowanie dat do wyświetlenia
            const formattedDates = data.dates.map(date => {
                const [year, month] = date.split('-');
                return moment(`${year}-${month}-01`).format('MMM YYYY');
            });
            
            // Ustawienie aktualnych wartości
            updateCurrentValues(data);
            
            // Utworzenie checkboxów dla miar
            createMeasureCheckboxes(data.categories);
            
            // Inicjalizacja wykresów
            const charts = initializeCharts(data, formattedDates);
            
            // Obsługa filtrów
            handleFilters(data, formattedDates, charts);
        }

        // Funkcja do aktualizacji aktualnych wartości
        function updateCurrentValues(data) {
            const currentValuesElement = document.getElementById('current-values');
            currentValuesElement.innerHTML = '';
            
            // Pokazujemy tylko wybrane główne miary (np. M1, M2, M3)
            const mainMeasures = ['M1', 'M2', 'M3'];
            
            mainMeasures.forEach(measure => {
                if (data.categories.includes(measure)) {
                    const value = data.latestValues[measure];
                    const growthRate = data.latestGrowthRates[measure];
                    const growthClass = growthRate >= 0 ? 'text-green-600' : 'text-red-600';
                    const growthSign = growthRate >= 0 ? '+' : '';
                    
                    const html = `
                        <div class="bg-${getMeasureColor(measure)}-50 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-${getMeasureColor(measure)}-800">${measure}</h3>
                            <p class="text-2xl font-bold">${formatNumber(value)}</p>
                            <p class="text-sm ${growthClass}">${growthSign}${growthRate.toFixed(1)}% r/r</p>
                        </div>
                    `;
                    
                    currentValuesElement.innerHTML += html;
                }
            });
        }

        // Funkcja do tworzenia checkboxów dla miar
        function createMeasureCheckboxes(categories) {
            const measuresContainer = document.getElementById('measures-checkboxes');
            measuresContainer.innerHTML = '';
            
            // Sortujemy kategorie, M1, M2, M3 na początek, potem reszta alfabetycznie
            const mainMeasures = ['M1', 'M2', 'M3'];
            const otherMeasures = categories.filter(cat => !mainMeasures.includes(cat)).sort();
            const sortedCategories = [...mainMeasures.filter(m => categories.includes(m)), ...otherMeasures];
            
            sortedCategories.forEach(category => {
                const color = getMeasureColor(category);
                const isMainMeasure = mainMeasures.includes(category);
                
                const html = `
                    <div class="flex items-center">
                        <input type="checkbox" id="check-${category}" class="h-4 w-4 text-${color}-600 focus:ring-${color}-500 border-gray-300 rounded" ${isMainMeasure ? 'checked' : ''}>
                        <label for="check-${category}" class="ml-2 text-sm text-gray-700">${category}</label>
                    </div>
                `;
                
                measuresContainer.innerHTML += html;
            });
        }

        // Funkcja do inicjalizacji wszystkich wykresów
        function initializeCharts(data, formattedDates) {
            // Struktura dla przechowywania referencji do wykresów
            const charts = {};
            
            // Definiowanie kolorów dla różnych miar
            const colors = {
                'M1': '#3b82f6', // blue
                'M2': '#4f46e5', // indigo
                'M3': '#7c3aed', // purple
                'default': '#d946ef' // fuchsia jako domyślny
            };
            
            // 1. Wykres liniowy - wartości bezwzględne (agregaty)
            charts.aggregateChart = createAggregateChart(data, formattedDates, colors);
            
            // 2. Wykres słupkowy - dynamika zmian (r/r)
            charts.growthChart = createGrowthChart(data, formattedDates, colors);
            
            // 3. Wykres kołowy - struktura M3
            charts.structureChart = createStructureChart(data);
            
            // 4. Wykres obszarowy - porównanie agregatów
            charts.comparisonChart = createComparisonChart(data, formattedDates, colors);
            
            return charts;
        }

        // Funkcja do tworzenia wykresu agregatów
        function createAggregateChart(data, formattedDates, colors) {
            const mainMeasures = ['M1', 'M2', 'M3'];
            const visibleMeasures = mainMeasures.filter(m => data.categories.includes(m));
            
            const series = visibleMeasures.map(measure => ({
                name: measure,
                data: data.measures[measure]
            }));
            
            const options = {
                series: series,
                chart: {
                    height: 320,
                    type: 'line',
                    toolbar: {
                        show: true
                    },
                    zoom: {
                        enabled: true
                    }
                },
                colors: visibleMeasures.map(m => colors[m] || colors.default),
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                grid: {
                    borderColor: '#f3f4f6',
                    row: {
                        colors: ['#f8fafc', 'transparent'],
                        opacity: 0.2
                    }
                },
                markers: {
                    size: 0
                },
                xaxis: {
                    categories: formattedDates,
                    labels: {
                        rotate: -45,
                        style: {
                            fontSize: '10px'
                        }
                    },
                    tickAmount: 10
                },
                yaxis: {
                    title: {
                        text: 'mln PLN'
                    },
                    labels: {
                        formatter: function(val) {
                            return formatNumber(val);
                        }
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(val) {
                            return formatNumber(val) + ' mln PLN';
                        }
                    }
                },
                legend: {
                    position: 'top'
                }
            };
            
            const chart = new ApexCharts(document.querySelector("#aggregateChart"), options);
            chart.render();
            
            return chart;
        }

        // Funkcja do tworzenia wykresu dynamiki zmian
        function createGrowthChart(data, formattedDates, colors) {
            const mainMeasures = ['M1', 'M2', 'M3'];
            const visibleMeasures = mainMeasures.filter(m => data.categories.includes(m));
            
            const series = visibleMeasures.map(measure => ({
                name: measure,
                data: data.growthRates[measure]
            }));
            
            const options = {
                series: series,
                chart: {
                    type: 'bar',
                    height: 320,
                    toolbar: {
                        show: true
                    }
                },
                colors: visibleMeasures.map(m => colors[m] || colors.default),
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '80%',
                        borderRadius: 4
                    }
                },
                dataLabels: {
                    enabled: false
                },
                xaxis: {
                    categories: formattedDates,
                    labels: {
                        rotate: -45,
                        style: {
                            fontSize: '10px'
                        }
                    },
                    tickAmount: 10
                },
                yaxis: {
                    title: {
                        text: 'Zmiana r/r (%)'
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(val) {
                            return val.toFixed(1) + '%';
                        }
                    }
                },
                legend: {
                    position: 'top'
                }
            };
            
            const chart = new ApexCharts(document.querySelector("#growthChart"), options);
            chart.render();
            
            return chart;
        }

        // Funkcja do tworzenia wykresu struktury M3
        function createStructureChart(data) {
            // Komponenty M3 (przykładowo)
            const m3Components = {
                'Gotówka w obiegu': 'M0',
                'Depozyty bieżące gospodarstw domowych': 'Depozyty_biezace_gospodarstw_domowych',
                'Depozyty bieżące przedsiębiorstw': 'Depozyty_biezace_przedsiebiorstw',
                'Depozyty terminowe': 'Depozyty_terminowe'
            };
            
            // Weryfikacja dostępnych danych
            const availableComponents = Object.entries(m3Components).filter(
                ([name, key]) => data.categories.includes(key)
            );
            
            // Przygotowanie danych do wykresu
            const series = availableComponents.map(([name, key]) => data.latestValues[key]);
            const labels = availableComponents.map(([name, _]) => name);
            
            const options = {
                series: series,
                chart: {
                    height: 320,
                    type: 'pie'
                },
                labels: labels,
                colors: ['#3b82f6', '#4f46e5', '#7c3aed', '#8b5cf6', '#a855f7'],
                legend: {
                    position: 'bottom'
                },
                responsive: [{
                    breakpoint: 480,
                    options: {
                        chart: {
                            width: 300
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }],
                tooltip: {
                    y: {
                        formatter: function(val) {
                            return formatNumber(val) + ' mln PLN';
                        }
                    }
                }
            };
            
            const chart = new ApexCharts(document.querySelector("#structureChart"), options);
            chart.render();
            
            return chart;
        }

        // Funkcja do tworzenia wykresu porównawczego
        function createComparisonChart(data, formattedDates, colors) {
            const mainMeasures = ['M1', 'M2', 'M3'];
            const visibleMeasures = mainMeasures.filter(m => data.categories.includes(m));
            
            const series = visibleMeasures.map(measure => ({
                name: measure,
                data: data.measures[measure]
            }));
            
            const options = {
                series: series,
                chart: {
                    type: 'area',
                    height: 320,
                    stacked: false,
                    toolbar: {
                        show: true
                    }
                },
                colors: visibleMeasures.map(m => colors[m] || colors.default),
                dataLabels: {
                    enabled: false
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        opacityFrom: 0.6,
                        opacityTo: 0.1
                    }
                },
                xaxis: {
                    categories: formattedDates,
                    labels: {
                        rotate: -45,
                        style: {
                            fontSize: '10px'
                        }
                    },
                    tickAmount: 10
                },
                yaxis: {
                    title: {
                        text: 'mln PLN'
                    },
                    labels: {
                        formatter: function(val) {
                            return formatNumber(val);
                        }
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(val) {
                            return formatNumber(val) + ' mln PLN';
                        }
                    }
                }
            };
            
            const chart = new ApexCharts(document.querySelector("#comparisonChart"), options);
            chart.render();
            
            return chart;
        }

        // Obsługa filtrów
        function handleFilters(data, formattedDates, charts) {
            // Obsługa zakresu czasowego
            document.getElementById('timeRange').addEventListener('change', function() {
                const timeRange = this.value;
                let filteredDates = formattedDates;
                let filteredData = {...data};
                
                // Filtrowanie danych według wybranego zakresu
                if (timeRange !== 'all') {
                    let monthsToShow = 12; // default 1 rok
                    
                    if (timeRange === '5y') {
                        monthsToShow = 60;
                    } else if (timeRange === '10y') {
                        monthsToShow = 120;
                    }
                    
                    // Ograniczenie liczby dat do ostatnich X miesięcy
                    const totalMonths = formattedDates.length;
                    const startIndex = Math.max(0, totalMonths - monthsToShow);
                    
                    filteredDates = formattedDates.slice(startIndex);
                    
                    // Aktualizacja danych dla każdej miary
                    Object.keys(data.measures).forEach(measure => {
                        filteredData.measures[measure] = data.measures[measure].slice(startIndex);
                        filteredData.growthRates[measure] = data.growthRates[measure].slice(startIndex);
                    });
                }
                
                // Pobieranie aktualnie zaznaczonych miar
                const selectedMeasures = [];
                data.categories.forEach(category => {
                    const checkbox = document.getElementById(`check-${category}`);
                    if (checkbox && checkbox.checked) {
                        selectedMeasures.push(category);
                    }
                });
                
                // Aktualizacja wykresów
                updateCharts(charts, filteredData, filteredDates, selectedMeasures);
            });
            
            // Obsługa checkboxów z miarami
            data.categories.forEach(category => {
                const checkbox = document.getElementById(`check-${category}`);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        // Pobranie aktualnie zaznaczonych miar
                        const selectedMeasures = [];
                        data.categories.forEach(cat => {
                            const cb = document.getElementById(`check-${cat}`);
                            if (cb && cb.checked) {
                                selectedMeasures.push(cat);
                            }
                        });
                        
                        // Pobranie aktualnego zakresu dat
                        const timeRange = document.getElementById('timeRange').value;
                        let filteredDates = formattedDates;
                        let filteredData = {...data};
                        
                        if (timeRange !== 'all') {
                            let monthsToShow = 12; // default 1 rok
                            
                            if (timeRange === '5y') {
                                monthsToShow = 60;
                            } else if (timeRange === '10y') {
                                monthsToShow = 120;
                            }
                            
                            const totalMonths = formattedDates.length;
                            const startIndex = Math.max(0, totalMonths - monthsToShow);
                            
                            filteredDates = formattedDates.slice(startIndex);
                            
                            Object.keys(data.measures).forEach(measure => {
                                filteredData.measures[measure] = data.measures[measure].slice(startIndex);
                                filteredData.growthRates[measure] = data.growthRates[measure].slice(startIndex);
                            });
                        }
                        
                        // Aktualizacja wykresów
                        updateCharts(charts, filteredData, filteredDates, selectedMeasures);
                    });
                }
            });
        }

        // Funkcja do aktualizacji wykresów
        function updateCharts(charts, data, dates, selectedMeasures) {
            // Definiowanie kolorów dla różnych miar
            const colors = {
                'M1': '#3b82f6', // blue
                'M2': '#4f46e5', // indigo
                'M3': '#7c3aed', // purple
                'default': '#d946ef' // fuchsia jako domyślny
            };
            
            // Aktualizacja wykresu agregatów
            const aggregateSeries = selectedMeasures.map(measure => ({
                name: measure,
                data: data.measures[measure]
            }));
            
            charts.aggregateChart.updateOptions({
                xaxis: {
                    categories: dates
                }
            });
            charts.aggregateChart.updateSeries(aggregateSeries);
            
            // Aktualizacja wykresu dynamiki zmian
            const growthSeries = selectedMeasures.map(measure => ({
                name: measure,
                data: data.growthRates[measure]
            }));
            
            charts.growthChart.updateOptions({
                xaxis: {
                    categories: dates
                }
            });
            charts.growthChart.updateSeries(growthSeries);
            
            // Aktualizacja wykresu porównawczego
            charts.comparisonChart.updateOptions({
                xaxis: {
                    categories: dates
                }
            });
            charts.comparisonChart.updateSeries(aggregateSeries);
        }

        // Pomocnicze funkcje
        function formatNumber(number) {
            return new Intl.NumberFormat('pl-PL').format(Math.round(number));
        }

        function getMeasureColor(measure) {
            if (measure === 'M1') return 'blue';
            if (measure === 'M2') return 'indigo';
            if (measure === 'M3') return 'purple';
            return 'fuchsia';
        }
    </script>
</body>
</html>
